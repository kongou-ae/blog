---
title: CircleCIでRedPenを動かす
author: kongou_ae
layout: post
date: 2015-11-25
url: /blog/archives/2686
categories:
  - uncategorized
---

## はじめに

[RedPenにスペルチェック機能を追加する](http://aimless.jp/blog/archives/2685/)の続きです。CircleCI上でRedPenを動かしてみました。
> RedPenを利用したスペルチェックがローカル環境で動くことを確認しました。JavaScriptでチェック項目を拡張できるのがいいですね。次はスペルチェック用辞書の単語を増やした上で、CircleCI上で動作させてみようと思います。

## コンテナの仕込み

CircleCIのコンテナでRedPenを動かさなければなりません。RedPenはJava 1.8が必要なのでcircle.ymの`machine`の箇所に追加します。また、RedPenそのものをダウンロードしなければなりませんので、`dependencies`の箇所でアーカイブのダウンロードと展開、削除を行います。

```circle.yml
machine:
  timezone: Asia/Tokyo
  java:
    version: oraclejdk8

dependencies:
  pre:
    - wget https://github.com/RedPen-cc/RedPen/releases/download/v1.4.1/RedPen-1.4.1.tar.gz
    - tar xvf RedPen-1.4.1.tar.gz
    - rm RedPen-1.4.1.tar.gz
```

## テストの仕込み

RedPenで独自JavaScriptを利用するためには、設定ファイルとJavaScriptファイルが必要です。せっかくなので、これらもリポジトリで管理します。ブログ用リポジトリにRedPenの設定ファイルとスペルチェック用JavaScriptを配置します。

![](http://aimless.jp/blog/images/20151125-01.png)

circle.yml上でテスト方法を定義する必要があるのですが、「直近の変更が.mdファイルの時だけテストを実行する」という書き方が分かりませんでした。しこで、circle.ymlでは「直近の変更が.mdファイルの時だけテストを実行する」というスクリプトを実行することにしました。

今回は以下のテストスクリプトを利用します。主に2つの作業を行っています。

1. ブログ用リポジトリからダウンロードしたRedPenの設定ファイルと独自JavaScriptを、RedPen指定のディレクトリに移動する
2. `git diff`で直近の変更の差分からファイル名のみ取得し、そのファイル名が.mdであればRedPenによるテストを実行するスクリプトです。

```
#!/bin/sh
mv RedPen/blog.xml RedPen-*/conf
mv RedPen/spellCheck.js RedPen-*/js

filename=`git diff HEAD^ HEAD --name-only`

if [[ $filename =~ .*\.md$ ]] ;then
    echo "start to test $filename...."
    RedPen-*/bin/RedPen -c RedPen-*/conf/blog.xml -f markdown $filename
else
    echo "$filename is not markdown. The test will not be performed."
fi
```

### 実行

試してみましょう。書きかけのこのエントリをブログ用リポジトリにプッシュしてみます。slackから通知があるまで、艦これでもやりつつ待ちます。

```
C:\hugo\aimless.jp [master +1 ~0 -1 !]> git add content/blog/archives/2015-11-25-post-2686.md
C:\hugo\aimless.jp [master +1 ~0 -0 | +0 ~0 -1]> git commit -m "release 2686"
[master c37a1b3] release 2686
 1 file changed, 63 insertions(+)
 create mode 100644 content/blog/archives/2015-11-25-post-2686.md
C:\hugo\aimless.jp [master +0 ~0 -1]> git push origin master
Counting objects: 10, done.
Delta compression using up to 4 threads.
Compressing objects: 100% (6/6), done.
Writing objects: 100% (6/6), 1.88 KiB | 0 bytes/s, done.
Total 6 (delta 2), reused 0 (delta 0)
To https://github.com/kongou-ae/blog.git
   ec474a3..c37a1b3  master -> master
C:\hugo\aimless.jp [master +0 ~0 -1]>
```

テストが失敗しました。

![](http://aimless.jp/blog/images/20151125-02.png)

結果を見てみましょう。

![](http://aimless.jp/blog/images/20151125-03.png)

以下4項目で怒られていますので直して再プッシュします。

- RedPenはスペルミスの可能性があります
- JavaScriptはスペルミスの可能性があります
- The length of the sentence (116) exceeds the maximum of 100. at line
- Found invalid Katakana end-hypen "エントリ"
