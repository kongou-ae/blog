---
title: CircleCIでRedPenを動かす
author: kongou_ae
layout: post
date: 2015-11-25
url: /blog/archives/2686
categories:
  - uncategorized
---

## はじめに

[RedPenにスペルチェック機能を追加する](http://aimless.jp/blog/archives/2685/)の続きです。CircleCI上でRedpenを動かしてみました。
> RedPenを利用したスペルチェックがローカル環境で動くことを確認しました。JavaScriptでチェック項目を拡張できるのがいいですね。次はスペルチェック用辞書の単語を増やした上で、CircleCI上で動作させてみようと思います。

## コンテナの仕込み

CircleCIのコンテナでRedPenを動かさなければなりません。RedPenはJava 1.8が必要なのでcircle.ymの`machine`の箇所に追加します。また、RedPenそのものをダウンロードしなければなりませんので、`dependencies`の箇所でアーカイブのダウンロードと展開、削除を行います。

```circle.yml
machine:
  timezone: Asia/Tokyo
  java:
    version: oraclejdk8

dependencies:
  pre:
    - wget https://github.com/redpen-cc/redpen/releases/download/v1.4.1/redpen-1.4.1.tar.gz
    - tar xvf redpen-1.4.1.tar.gz
    - rm redpen-1.4.1.tar.gz
```

## テストの仕込み

RedPenで独自Javascriptを利用するためには、設定ファイルとJavascriptファイルが必要です。せっかくなので、これらもリポジトリで管理します。ブログ用リポジトリにRedpenの設定ファイルとスペルチェック用Javascriptを配置します。

![](http://aimless.jp/blog/images/20151125-01.png)

circle.yml上で「直近の変更が.mdファイルの時だけテストを実行する」という書き方がわからなかったので、circle.ymlでは「直近の変更が.mdファイルの時だけテストを実行する」というスクリプトを実行することにしました。

今回は以下のテストスクリプトを利用します。主に2つの作業を行っています。

1. ブログ用リポジトリからダウンロードしたRedPenの設定ファイルと独自Javascriptを、RedPen指定のディレクトリに移動する
2. `git diff`で直近の変更の差分からファイル名のみ取得し、そのファイル名が.mdであればRedPenによるテストを実行するスクリプトです。

```
#!/bin/sh
mv redpen/blog.xml redpen-*/conf
mv redpen/spellCheck.js redpen-*/js

filename=`git diff HEAD^ HEAD --name-only`

if [[ $filename =~ .*\.md$ ]] ;then
    echo "start to test $filename...."
    redpen-*/bin/redpen -c redpen-*/conf/blog.xml -f markdown $filename
else
    echo "$filename is not markdown. The test will not be performed."
fi
```

### 実行

試してみましょう。書きかけのこのエントリーをブログ用リポジトリにプッシュしてみます。
