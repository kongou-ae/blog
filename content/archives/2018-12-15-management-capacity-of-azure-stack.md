---
title: Azure Stack のキャパシティを管理する
author: kongou_ae
date: 2018-12-15
url: /archives/2018-12-15-management-capacity-of-azure-stack
categories:
  - azurestack
---

## はじめに

本エントリーは[Microsoft Azure Stack Advent Calendar 2018](https://qiita.com/advent-calendar/2018/azure-stack)の15日目です。

本日のエントリでは、Azure Stack のキャパシティを管理する方法をまとめます。

## 有限のキャパシティ

パブリッククラウドのキャパシティは有限です。クラウドを支える物理リソースが有限だからです。したがって、利用者に自由にリソースを作らせてしまうと、特定ユーザのためにパブリッククラウド全体のキャパシティが枯渇してしますリスクがあります。

そのため、パブリッククラウド事業者は、利用者が利用できるリソースを制限しています。Azure ではクオータという仕組みを利用して、利用者が利用できるリソースを制限しています。

たとえば、私が個人で契約している Azure のサブスクリプションには、１つのリージョンに作成できる vCPU の数が20に制限されています。他にもさまざまなリソースが制限されています。全てはキャパシティの枯渇を防ぐためです。

{{< figure src="./../../images/2018-12-15-002" title="サブスクリプションに設定されているクオータ" >}}
 
## Azure Stack のキャパシティ管理

Azure と一貫性のある Azure Stack も、Azure と同じ考え方がとられており、クオータを利用して利用者が利用できるリソースを制限する実装がなされています。リソースを制限する際に利用する機能が次の４つです。

* クオータ
* プラン
* オファー
* ユーザ サブスクリプション

### クオータ

クオータとは、利用できるリソースの上限を定義したものです。コンピュータのクオータやストレージのクオータ、ネットワークのクオータなどサービスごとにクオータが存在します。各クオータでは、上限を設定できるリソースの種類が決まっています。たとえばコンピュータのクオータでは仮想マシンの数やコア数などの上限を設定できます。



クオータで利用できるリソースの種類の詳細は次の URL に記載されています。

参考：[Azure Stack のクォータの種類](https://docs.microsoft.com/ja-jp/azure/azure-stack/azure-stack-quota-types)

### プラン
 
ブランとは、各種サービスのクオータを意味のある粒度でまとめたものです。利用できるリソースが少ない各サービスのクオータをまとめて「お試しプラン」を作ったり、ストレージのクオータだけを持つ「ストレージだけ使えるプラン」というキワモノを作ったりできます。

下図は、Azure Stack のすべてのサービスが利用できるプランです。1つのオファーの中にサービスごとのプランが含まれていることが分かります。

{{<img src="./../../images/2018-12-15-003.png">}}



### オファー

オファーとは、プランを利用者に提供するためのもののです。オファーはほ1つ以上のプランで構成されています。したがって、オファーを


### ユーザサブスクリプション

ユーザーサブスクリプションとは、ユーザとオファーをつなぐものです。

## 制限を超えると？

管理者がクオータで割り当てた制限を超えてリソースを作ろうとした場合、その要求が失敗します。


## まとめ

本日のエントリでは、キャパシティを管理する仕組みであるクオータとプラン、オファー、サブスクリプションについてお話ししました。利用者に沢山のキャパシティを与えると基盤の上限を超えてしまい利用者全体に迷惑がかかります。一方で、制限を厳しくしすぎるとセルフサービスのメリットが失われてしまいます。

組織のあり方とAzure Sta ck の使い方を踏まえて、良い塩梅を見つけて運用しましょう。
